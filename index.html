<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/x-icon" href="logo.png">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Silkscreen|Ubuntu+Mono|Roboto+Mono">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <!-- <link rel="stylesheet" type="text/css" href="style.css"> -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <title>SNIPERFIER</title>
  </head>
  <body>
    <div class="hero">
      <img src="snipe.png">
    </div>
    <div class="ml3">
      <input type="file" id="image-input" accept="image/jpeg, image/png, image/jpg">
    </div>
    <div class="ml3">
      <button onclick="imgGen();">Download</button>
    </div>
    <div>
      <div class="ml3" id="cmyk">
        <img id="cmykImg" src="cmyk.png">
      </div>
      <img class="ml3" id="display-image"></img>
    </div>
    <div>
      <canvas id="dl-img"></canvas>
    </div>
  </body>

  <script>
    const image_input = document.querySelector("#image-input");
    image_input.addEventListener("change", function() {
      const reader = new FileReader();
      reader.addEventListener("load", () => {
        const uploaded_image = reader.result;
        document.querySelector("#display-image").src = uploaded_image;
        console.log($('#display-image').width());
      });
      reader.readAsDataURL(this.files[0]);
      setTimeout(function function_name(argument) {
        var dw = $('#display-image').width();
        var dh = $('#display-image').height();
        $('#cmyk, #dl-img').css({'height':dh, 'width':dw});
      }, 50);
      
    });
  </script>

  <style type="text/css">
    button {
      color: white;
      background-color: black;
      padding: 0.25em 1em;
      border-radius: 2em;
      font-weight: 600;
      text-transform: uppercase;
    }
    #cmyk>img {
      margin: 0 10px 10px 0;
      min-width: 50px;
    }

    .hero>img {
      width: 150px;
      padding: 1em 0;
    }

    #image-input {
      margin: 1em 0;
    }

    .hero {
      background-color: black;
      color: white;
      display: flex;
      align-content: center;
      justify-content: flex-start;
      align-items: center;
    }

    .hero>img {
      margin: 0 3em;
    }

    #cmyk {
      left: 0px; 
      top: 180px; 
      position: absolute; 
      max-width: calc(100% - 6em);
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      justify-content: flex-end;
      z-index: 200;
    }

    #display-image{
      left: 0px; 
      top: 180px; 
      position: absolute;
      max-width: calc(100% - 6em);
      border: 1px solid black;
      z-index: 100;
      filter: saturate(0.75) contrast(1.1);
      margin-bottom: 5em;
    }

    #dl-img{
      left: 3em; 
      top: 180px; 
      position: absolute;
      max-width: calc(100% - 6em);
      z-index: 0;
      filter: saturate(0.75) contrast(1.1);
      margin-bottom: 5em;
    }

    .ml3 {
      margin: 0 3em;
    }
  </style>

  <script type="text/javascript">
    var w = $('#cmyk').width() * 0.125;
    $('#cmyk>img').css('width', w + 'px');
    $('body').css('height',(window.outerHeight+80)+'px');

    function imgGen () {
      var img = document.getElementById('display-image');
      var img2 = document.getElementById('cmykImg');
      const myCanvas = document.getElementById('dl-img');
      const originalHeight = myCanvas.height;
      const originalWidth = myCanvas.width;
      render();
      function render() {
        let dimensions = getObjectFitSize(
          true,
          myCanvas.clientWidth,
          myCanvas.clientHeight,
          myCanvas.width,
          myCanvas.height
        );
        const dpr = window.devicePixelRatio || 1;
        myCanvas.width = dimensions.width * dpr;
        myCanvas.height = dimensions.height * dpr;

        let ctx = myCanvas.getContext('2d');
        let ratio = Math.min(
          myCanvas.clientWidth / originalWidth,
          myCanvas.clientHeight / originalHeight
        );

        ctx.filter = 'saturate(0.75) contrast(1.1)';
        ctx.drawImage(img, 0, 0, myCanvas.width, myCanvas.height);
        ctx.drawImage(img2, myCanvas.width - (myCanvas.width*0.2) - 10, myCanvas.width - (myCanvas.width*0.2*.25) - 10, myCanvas.width*0.2, myCanvas.width*0.2*.25);
      };

      function getObjectFitSize(
        contains /* true = contain, false = cover */,
        containerWidth,
        containerHeight,
        width,
        height
      ) {
        var doRatio = width / height;
        var cRatio = containerWidth / containerHeight;
        var targetWidth = 0;
        var targetHeight = 0;
        var test = contains ? doRatio > cRatio : doRatio < cRatio;

        if (test) {
          targetWidth = containerWidth;
          targetHeight = targetWidth / doRatio;
        } else {
          targetHeight = containerHeight;
          targetWidth = targetHeight * doRatio;
        }

        return {
          width: targetWidth,
          height: targetHeight,
          x: (containerWidth - targetWidth) / 2,
          y: (containerHeight - targetHeight) / 2
        };
      };
      $('#dl-img').show();
      dlImg();
    }

    function dlImg(){
      var canvas = document.getElementById('dl-img');
      image = canvas.toDataURL("image/png").replace('image/png', 'image/octet-stream');
      var link = document.createElement('a');
      link.download = 'twitterImg.png';
      link.href = image;
      link.click();
    }
  </script>
</html>